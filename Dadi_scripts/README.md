# Dadi

 *dadi* simulation scripts for Ifremeria paper!

## Downloading the Used Version
You can download the version of *dadi* that I used from the following GitLab repository: [Gitlab_Khalid_Dadi](https://gitlab.mbb.univ-montp2.fr/khalid/dadi/-/tree/master). This version incorporates a *dual annealing* function to find the optimized likelihood.

**Caution**: I'm utilizing a Python environment with **conda** to install and run *dadi* within it. However, *dadi* can also be installed directly in a Linux environment without requiring a specific environment like the one I use. If you choose to do a direct installation, simply comment out the line "source activate dadi_sim" in the scripts.

## Converting VCF to dadi Format
To generate a spectrum file from a VCF (Variant Call Format) file, I have adapted a personal script based on the example provided in the [official dadi documentation](https://dadi.readthedocs.io/en/latest/user-guide/importing-data/). To run this script, you need to provide several arguments in the specified order as shown in the command below:

``` 
python3 fs_from_VCF_arg.py myVCF my_popmap_file 50 outputname pop1 pop2 
``` 

This script will generate two files: a spectrum file and an associated figure depicting the spectrum. Feel free to open the script to understand its functionality. 
In my case, I included two line to exclude singletons from the generated spectrum.

## Model Types
These scripts include 28 divergence models for two populations. All these models have been rewritten with slight modifications and originate from [Rougueux et al., 2017](https://doi.org/10.1093/gbe/evx150). When using these models, make sure to cite both their work and the *dadi* papers.

In addition to the existing models from the previous paper, i have added the IM2N2M and IM2N2mG models. For the (IM/AM/SC) models, population growth (G) is considered only during the migration phase.

Two versions of the models are provided, as shown in the figures below:
1. *model_no_NA* contains all the models without any changes to the ancestral population prior to the split/divergence.
   - Example Figure A
2. *model_NA_Change* contains all the models with a change in the ancestral population prior to the split/divergence.
   - Example Figure B

The change in the ancestral population is included to simulate instantaneous population bottlenecks or expansions before the split, as described in [Momigliano et al., 2021](https://doi.org/10.1093/molbev/msab047).

Depending on the type of model you wish to use, modify the name of the script *call_all_model_NA_change.py* to *call_all_model_no_NA_change.py* in either the bash script or the terminal command.

## Example Model
![Dessin_model_Nachange_noNa3](https://github.com/Atranluy/Scripts-Ifremeria/assets/84977797/442131fa-3175-453f-be86-c8af1ff0440b)

## Running Simulations with the Scripts
There are two main ways to run these scripts.

### Using the Bash Script for Multiple Jobs 
(Works on HPC)

Place all the scripts in a single folder and use the bash script **Multi_Launch_dadi.sh**. In this script, specify the name of the spectrum file generated by *dadi* as follows:

``` 
FS=my_spectrum_file_name
``` 

Next, in the following lines,

you need to specify the models you want to run and the number of independent runs for each model. In the example provided, I ran two models, **SC2N2m** and **AM2N2m**, for 11 independent runs:

``` 
for model in SC2N2m AM2N2m;
do
for i in `seq 1 11`;
do
``` 

### Direct Execution 
(Closing the terminal will stop the computation)

You can also run the command directly from the terminal by providing three arguments for the simulation:

1. The model you want to use, for example, **IM2m**.
2. The spectrum file.
3. The iteration number (must be an integer).

For example, to run a simulation for the model **IM2m** in the 9th run on the *noNA_change* models, execute the following command:

```
python3 call_all_model_noNA_change.py IM2m my_spectrum_file_name 9 
```

### Adding Additional Models
If you want to add more models to these scripts, whether for the *NA_change* or *no_Na_Change* versions, you can open the respective scripts (*model_NA_change.py* or *model_No_NA_change.py*) and add your model as a function at the end. Additionally, in the **Call_all_model** Python script, add your model and parameter bounds to the corresponding **elif** condition, following the structure of the existing models.

